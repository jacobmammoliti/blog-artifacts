from fastapi.testclient import TestClient
import http
import json

from .main import app, cities

client = TestClient(app)

# ------------------------------------------------------------------
# Using http.client to make real HTTP requests.
# Requires the server to be running.
# ------------------------------------------------------------------
def _make_request(path: str):
    conn = http.client.HTTPConnection("127.0.0.1", 8000, timeout=5)
    conn.request("GET", path)
    response = conn.getresponse()
    body = response.read()
    conn.close()
    return response.status, body

def test_health_endpoint_http():
    status, body = _make_request("/healthz")
    assert status == 200
    assert body == b'{"msg":"It works!"}'

def test_cities_endpoint_http():
    status, body = _make_request("/cities")
    assert status == 200
    assert json.loads(body.decode()) == cities

def test_single_city_endpoint_http():
    status, body = _make_request("/cities?name=Toronto")
    assert status == 200
    assert json.loads(body.decode()) == [cities[0]]

# ------------------------------------------------------------------
# Using TestClient from FastAPI.
# Does not require an HTTP socket connection.
# ------------------------------------------------------------------
def test_health_endpoint():
    response = client.get("/healthz")
    assert response.status_code == 200
    assert response.json() == {"msg": "It works!"}

def test_cities_endpoint():
    response = client.get("/cities")
    assert response.status_code == 200
    assert response.json() == cities

def test_single_city_endpoint():
    response = client.get("/cities?name=Toronto")
    assert response.status_code == 200
    assert response.json() == [cities[0]]